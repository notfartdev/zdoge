# Change Notes Implementation - Verification Checklist

## âœ… Circuit Verification

### swap.circom
- âœ… Public inputs: 8 total
  - [0] root
  - [1] inputNullifierHash
  - [2] outputCommitment1
  - [3] outputCommitment2 (can be 0)
  - [4] tokenInAddress
  - [5] tokenOutAddress
  - [6] swapAmount
  - [7] outputAmount
- âœ… Change note support: changeAmount, changeSecret, changeBlinding
- âœ… Value conservation: inputAmount === swapAmount + changeAmount
- âœ… Circuit compiled successfully (43662 constraints)
- âœ… WASM and zkey files generated and copied to public/circuits/shielded/

---

## âœ… Contract Verification

### SwapVerifier.sol
- âœ… Function signature: `verifyProof(..., uint[8] calldata _pubSignals)`
- âœ… Contract name: `SwapVerifier` (not Groth16Verifier)
- âœ… Deployed at: `0x8677F89bc4ccc4a6eb9Eb28070a558A1358B8640`

### ShieldedPoolMultiToken.sol
- âœ… Swap function signature matches:
  - `outputCommitment1` âœ…
  - `outputCommitment2` âœ…
  - `swapAmount` âœ…
- âœ… Public inputs array: `uint256[8]` with correct order âœ…
- âœ… Both output commitments inserted into Merkle tree âœ…
- âœ… Event updated: includes `outputCommitment2` âœ…
- âœ… Deployed at: `0x40c74Fd9B171D34d971B182bDd5756fe39e477E9`

### ISwapVerifier Interface
- âœ… Interface signature: `uint[8] calldata _pubSignals` âœ…

---

## âœ… Frontend Verification

### lib/shielded/shielded-proof-service.ts
- âœ… `generateSwapProof` accepts `swapAmount` parameter âœ…
- âœ… Creates change note if `changeAmount > 0` âœ…
- âœ… Circuit input includes change note fields âœ…
- âœ… Public inputs: 8 total, correct order âœ…
- âœ… Returns both `outputNote` and `changeNote` âœ…

### lib/shielded/shielded-swap-service.ts
- âœ… `prepareShieldedSwap` returns `changeNote` and `changeCommitment` âœ…
- âœ… Handles partial swaps (swapAmount < inputNote.amount) âœ…

### components/shielded/swap-interface.tsx
- âœ… Extracts public inputs correctly (index 3, 7) âœ…
- âœ… Sends `outputCommitment1` and `outputCommitment2` to backend âœ…
- âœ… Sends `swapAmount` (not `amountIn`) âœ…
- âœ… Calls `completeSwap` with both notes âœ…
- âœ… Handles `outputLeafIndex1` and `outputLeafIndex2` âœ…

### lib/shielded/shielded-service.ts
- âœ… `completeSwap` accepts `changeNote` and `changeLeafIndex` âœ…
- âœ… Adds both output notes to wallet state âœ…

---

## âœ… Backend Verification

### backend/src/shielded/shielded-routes.ts
- âœ… ABI updated: swap function has correct parameters âœ…
- âœ… Accepts `outputCommitment1` and `outputCommitment2` âœ…
- âœ… Accepts `swapAmount` (not `amountIn`) âœ…
- âœ… Validates `outputCommitment2` can be 0 âœ…
- âœ… Passes both commitments to contract âœ…
- âœ… Returns both `outputLeafIndex1` and `outputLeafIndex2` âœ…

---

## âœ… Config Verification

### lib/dogeos-config.ts
- âœ… `shieldedPool.address`: `0x40c74Fd9B171D34d971B182bDd5756fe39e477E9` âœ…
- âœ… `shieldedPool.swapVerifier`: `0x8677F89bc4ccc4a6eb9Eb28070a558A1358B8640` âœ…
- âœ… All verifier addresses updated âœ…

---

## ğŸ” Integration Checks

### Public Inputs Order (Must Match Everywhere)
1. âœ… Circuit: `[root, inputNullifierHash, outputCommitment1, outputCommitment2, tokenInAddress, tokenOutAddress, swapAmount, outputAmount]`
2. âœ… Contract: `[root, inputNullifier, outputCommitment1, outputCommitment2, tokenInUint, tokenOutUint, swapAmount, outputAmount]`
3. âœ… Frontend proof generation: Same order âœ…
4. âœ… Frontend extraction: `publicInputs[3]` = outputCommitment2, `publicInputs[7]` = outputAmount âœ…
5. âœ… Backend: Passes in same order âœ…

### Change Note Logic
- âœ… Change calculated: `changeAmount = inputNote.amount - swapAmount` âœ…
- âœ… Change note created only if `changeAmount > 0` âœ…
- âœ… Change note uses same token as input âœ…
- âœ… Change note goes back to sender âœ…
- âœ… Change commitment can be 0 (no change) âœ…

---

## âš ï¸ Potential Issues to Watch

1. **Public Inputs Index:**
   - Frontend extracts `outputCommitment2` at index 3 âœ…
   - Frontend extracts `outputAmount` at index 7 âœ…
   - Order matches circuit âœ…

2. **Change Note Handling:**
   - Backend allows `outputCommitment2` to be 0x0 âœ…
   - Frontend handles null change notes âœ…
   - Wallet state updates correctly âœ…

3. **Leaf Index Tracking:**
   - Backend finds both leaf indices âœ…
   - Frontend receives both indices âœ…
   - Both notes added with correct indices âœ…

---

## ğŸ§ª Testing Checklist

Before testing, verify:
- [ ] Old notes cleared (if needed)
- [ ] New contract address in config
- [ ] Backend running and connected
- [ ] Frontend rebuild (if needed)
- [ ] Circuit WASM/zkey files in public/circuits/shielded/

Test scenarios:
- [ ] Full swap (no change): swapAmount === inputNote.amount
- [ ] Partial swap (with change): swapAmount < inputNote.amount
- [ ] Verify both output notes appear in wallet
- [ ] Verify change note has correct token
- [ ] Verify change note amount is correct

---

## âœ… Summary

**All components verified and aligned!** âœ…

- Circuit: 8 public inputs, change note support âœ…
- Contract: Correct signature, handles both commitments âœ…
- Frontend: Generates proofs with change, handles both notes âœ…
- Backend: Passes both commitments, returns both indices âœ…
- Config: All addresses updated âœ…

**Ready for testing!** ğŸš€
